# Система Моніторингу для Dynamic SkyBlock

Цей документ описує ключові метрики для моніторингу стану, продуктивності та надійності системи Dynamic SkyBlock. Метрики згруповані за компонентами: **API Backend**, **Minecraft Mod (`mods-server`)** та **Velocity Proxy Plugin (`Nestworldvelocity`)**.

---

## 1. API Backend (`api/`)

API є центральним компонентом системи, що керує всією логікою. Моніторинг його стану є критично важливим.

### 1.1. Загальні Метрики API

| Метрика                  | Опис                                                                 | Тип        | Інструмент для збору |
| ------------------------ | -------------------------------------------------------------------- | ---------- | -------------------- |
| **Кількість запитів (RPS)** | Загальна кількість HTTP-запитів на секунду до API.                   | Лічильник  | Prometheus (Exporter) |
| **Час відповіді (Latency)** | Середній, 95-й та 99-й перцентиль часу відповіді для всіх ендпоінтів. | Гістограма | Prometheus (Exporter) |
| **Коди відповідей HTTP**  | Кількість відповідей, згрупованих за кодами (2xx, 3xx, 4xx, 5xx).      | Лічильник  | Prometheus (Exporter) |
| **Завантаження CPU/RAM**   | Використання ресурсів процесором та пам'яттю.                         | Показник   | Node Exporter        |

### 1.2. Життєвий Цикл Островів

Ці метрики дозволяють відстежувати стан та продуктивність основної функціональності — керування островами.

| Метрика                              | Опис                                                                                                       | Тип       | Інструмент для збору                     |
| ------------------------------------ | ---------------------------------------------------------------------------------------------------------- | --------- | ---------------------------------------- |
| **Кількість островів за статусом**   | Кількість островів у кожному зі станів: `RUNNING`, `STOPPED`, `FROZEN`, `CREATING`, `ERROR`, `PENDING_START` тощо. | Показник  | Спеціальний експортер або запит до БД |
| **Тривалість операцій з островами**  | Середній час, що витрачається на операції: `create`, `start`, `stop`, `freeze`.                               | Показник  | Логи або Prometheus Summary/Histogram    |
| **Кількість помилок операцій**       | Кількість невдалих операцій `create`, `start`, `stop`, `freeze`.                                             | Лічильник | Логи або Prometheus Counter              |
| **Кількість активних фонових задач** | Кількість завдань, що виконуються у фоні (керування LXD).                                                  | Показник  | Внутрішній лічильник у `FastAPI`         |
| **Активні WebSocket з'єднання**     | Поточна кількість підключених WebSocket клієнтів.                                                          | Показник  | Внутрішній лічильник у `FastAPI`         |

### 1.3. Команди та Гравці

| Метрика                       | Опис                                         | Тип      | Інструмент для збору            |
| ----------------------------- | -------------------------------------------- | -------- | ------------------------------- |
| **Загальна кількість команд** | Загальна кількість створених команд.         | Показник | Запит до БД                     |
| **Гравців у команді**         | Середня, мін/макс кількість гравців у команді. | Показник | Запит до БД                     |

---

## 2. Minecraft Mod (`mods-server/`)

Мод, що працює на кожному сервері-острові, надає важливу інформацію про стан ігрового процесу.

### 2.1. Продуктивність Сервера

| Метрика              | Опис                                                      | Тип      | Інструмент для збору  |
| -------------------- | --------------------------------------------------------- | -------- | --------------------- |
| **TPS (Ticks Per Second)** | Показник продуктивності сервера. Ідеальне значення — 20. | Показник | Spark / вбудовані команди |
| **Використання RAM** | Кількість пам'яті, що використовується JVM.                | Показник | Spark / JMX Exporter  |
| **Кількість гравців**| Кількість гравців онлайн на конкретному острові.          | Показник | Spark / RCON          |

### 2.2. Взаємодія з API

| Метрика                           | Опис                                                                         | Тип       | Інструмент для збору |
| --------------------------------- | ---------------------------------------------------------------------------- | --------- | -------------------- |
| **Статус WebSocket з'єднання**    | Стан з'єднання з API (Connected / Disconnected).                              | Показник  | Логи мода            |
| **Час відправки "Ready Signal"**  | Час, що минув від старту сервера до відправки сигналу готовності до API.       | Показник  | Логи мода            |
| **Помилки завантаження конфігу**  | Кількість помилок при читанні `skyblock_island_data.toml`.                      | Лічильник | Логи мода            |

### 2.3. FTB Quests (якщо є інтеграція)

| Метрика                 | Опис                                      | Тип       | Інструмент для збору |
| ----------------------- | ----------------------------------------- | --------- | -------------------- |
| **Кількість виконаних квестів** | Загальна кількість завершених квестів.    | Лічильник | FTB Quests API       |
| **Активні квести**      | Кількість квестів, що виконуються гравцями. | Показник  | FTB Quests API       |

---

## 3. Velocity Proxy Plugin (`Nestworldvelocity/`)

Плагін для проксі-сервера є точкою входу для гравців і керує їх маршрутизацією.

### 3.1. Маршрутизація та Підключення

| Метрика                         | Опис                                                                                     | Тип        | Інструмент для збору    |
| ------------------------------- | ---------------------------------------------------------------------------------------- | ---------- | ----------------------- |
| **Гравці в черзі на підключення** | Кількість гравців у множині `awaitingConnection`, що чекають на запуск свого острова.       | Показник   | Prometheus (через плагін) |
| **Час очікування в черзі**      | Середній час, який гравець проводить у черзі, перш ніж його підключать до острова.      | Гістограма | Prometheus (через плагін) |
| **Кількість успішних підключень** | Кількість гравців, успішно перенаправлених на свій острів.                             | Лічильник  | Prometheus (через плагін) |
| **Кількість невдалих підключень** | Кількість гравців, чиє підключення до острова не вдалося (timeout, помилка API тощо).     | Лічильник  | Prometheus (через плагін) |

### 3.2. Взаємодія з API

| Метрика                      | Опис                                                                         | Тип        | Інструмент для збору    |
| ---------------------------- | ---------------------------------------------------------------------------- | ---------- | ----------------------- |
| **Час відповіді API (з Velocity)** | Час відповіді на запити від `ApiClient` до бекенду (напр., `get_island_status`). | Гістограма | Prometheus (через плагін) |
| **Помилки API (з Velocity)** | Кількість невдалих запитів до API з боку плагіна.                             | Лічильник  | Prometheus (через плагін) |

### 3.3. Використання Команд

| Метрика               | Опис                                                         | Тип       | Інструмент для збору    |
| --------------------- | ------------------------------------------------------------ | --------- | ----------------------- |
| **Частота команд**    | Кількість викликів команд `/myisland`, `/team`, `/tpa`, `/spawn` тощо. | Лічильник | Prometheus (через плагін) |

---

## Рекомендовані Інструменти для Моніторингу

*   **Prometheus**: для збору та зберігання метрик.
*   **Grafana**: для візуалізації метрик у вигляді дашбордів.
*   **Loki/ELK Stack**: для збору, аналізу та візуалізації логів з усіх компонентів.
*   **Spark**: для детального профілювання продуктивності Minecraft серверів.
