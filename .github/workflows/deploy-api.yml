name: Deploy API to Host Server

on:
  push:
    tags:
      - 'api-v*'

jobs:
  deploy-api:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy API via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          set -e
          echo "--- Starting API Deployment ---"
          cd ${{ secrets.API_PATH }}
          echo "--- Pulling latest changes from git ---"
          git fetch && git reset --hard origin/main
          echo "--- Installing dependencies into venv ---"
          # Chain commands to ensure pip runs inside the activated venv
          source ${{ secrets.API_PATH }}api/venv/bin/activate
          pip install -r requirements.txt
          echo "--- Restarting API service ---"
          sudo systemctl restart skyblock_api.service
          echo "--- Waiting for API to start (15s) ---"
          sleep 15
          echo "--- Performing health check ---"
          curl -fsL http://localhost:8000/ > /dev/null || (echo "API Health Check Failed" && exit 1)
          echo "--- API Deployment Successful ---"
