name: Build and Deploy Plugin

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      container_name:
        description: 'Target LXC container name (optional, uses default if empty)'
        required: false
        default: ''

jobs:
  build-and-deploy-plugin:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x ./Nestworldvelocity/gradlew

    - name: Build with Gradle
      run: ./Nestworldvelocity/gradlew -p Nestworldvelocity build

    - name: Find the JAR file
      id: find_jar
      run: |
        JAR_FILE=$(find Nestworldvelocity/build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar")
        echo "Found JAR: $JAR_FILE"
        echo "JAR_FILE_PATH=$JAR_FILE" >> $GITHUB_ENV
        
    - name: Set target container name
      id: set_container
      run: |
        if [ -n "${{ github.event.inputs.container_name }}" ]; then
          echo "CONTAINER=${{ github.event.inputs.container_name }}" >> $GITHUB_ENV
        else
          echo "CONTAINER=${{ secrets.VELOCITY_CONTAINER_NAME }}" >> $GITHUB_ENV
        fi

    - name: Copy JAR to Host via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        source: "${{ env.JAR_FILE_PATH }}"
        target: "/tmp/"

    - name: Push JAR to LXC Container
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          set -e
          # The scp action preserves the directory structure, so we need the full path
          JAR_FULL_REMOTE_PATH="/tmp/${{ env.JAR_FILE_PATH }}"
          JAR_NAME=$(basename "${{ env.JAR_FILE_PATH }}")
          LXC_CONTAINER="${{ env.CONTAINER }}"
          # The destination path inside the container only needs the JAR name
          LXC_DEST_PATH="${{ secrets.VELOCITY_DEST_PATH }}/$JAR_NAME"
          
          echo "--- Pushing $JAR_NAME from host path '$JAR_FULL_REMOTE_PATH' to LXC container '$LXC_CONTAINER' at '$LXC_DEST_PATH' ---"
          lxc file push --project "${{ secrets.LXD_PROJECT_NAME }}" "$JAR_FULL_REMOTE_PATH" "$LXC_CONTAINER/$LXC_DEST_PATH"
          
          echo "--- Cleaning up temporary directory on host ---"
          # This removes the top-level directory created by scp (e.g., /tmp/Nestworldvelocity)
          rm -rf "/tmp/Nestworldvelocity"
          echo "--- Plugin Deployment Successful ---"
