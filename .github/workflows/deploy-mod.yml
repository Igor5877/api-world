name: Build and Deploy Mod

on:
  push:
    tags:
      - 'mod-v*'
  workflow_dispatch:
    inputs:
      container_name:
        description: 'Target LXC container name (optional, uses default if empty)'
        required: false
        default: ''

jobs:
  build-and-deploy-mod:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x ./mods-server/gradlew

    - name: Build with Gradle
      run: ./mods-server/gradlew -p mods-server clean shadowJar

    - name: Prepare variables
      id: prep
      run: |
        JAR_PATH=$(find mods-server/build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -n 1)
        JAR_NAME=$(basename "$JAR_PATH")
        echo "JAR_PATH=$JAR_PATH" >> $GITHUB_ENV
        echo "JAR_NAME=$JAR_NAME" >> $GITHUB_ENV

        if [ -n "${{ github.event.inputs.container_name }}" ]; then
          echo "CONTAINER=${{ github.event.inputs.container_name }}" >> $GITHUB_ENV
        else
          echo "CONTAINER=${{ secrets.MOD_CONTAINER_NAME }}" >> $GITHUB_ENV
        fi

    - name: Copy JAR to Host via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        source: "${{ env.JAR_PATH }}"
        target: "/tmp/"
        strip_components: 3

    - name: Deploy, Restart, and Check
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          set -e
          LXC_CONTAINER="${{ env.CONTAINER }}"
          LXC_PROJECT="${{ secrets.LXD_PROJECT_NAME }}"
          MOD_DIR="${{ secrets.MOD_DEST_PATH }}"
          NEW_JAR_HOST_PATH="/tmp/${{ env.JAR_NAME }}"
          DEPLOYED_JAR_PATH="${MOD_DIR}/${{ env.JAR_NAME }}"

          echo "--- Preparing deployment for container: $LXC_CONTAINER ---"
          # Check if the file exists in the container and back it up
          if lxc exec --project "$LXC_PROJECT" "$LXC_CONTAINER" -- test -f "$DEPLOYED_JAR_PATH"; then
            echo "--- Backing up existing JAR: ${DEPLOYED_JAR_PATH} ---"
            lxc exec --project "$LXC_PROJECT" "$LXC_CONTAINER" -- mv "$DEPLOYED_JAR_PATH" "${DEPLOYED_JAR_PATH}.bak"
          fi

          echo "--- Pushing new JAR ---"
          lxc file push --project "$LXC_PROJECT" "$NEW_JAR_HOST_PATH" "$LXC_CONTAINER/${MOD_DIR}/"

          if [ -n "${{ secrets.MINECRAFT_RESTART_COMMAND }}" ]; then
            echo "--- Restarting server ---"
            lxc exec --project "$LXC_PROJECT" "$LXC_CONTAINER" -- ${{ secrets.MINECRAFT_RESTART_COMMAND }}
          else
            echo "--- WARNING: Restart command not set ---"
          fi

          echo "--- Installing mcstatus ---"
          pip install -U mcstatus --break-system-packages

          CONTAINER_IP=$(lxc list "$LXC_CONTAINER" --project "$LXC_PROJECT" -c 4 --format csv | awk 'NR==1{print $1}')
          MC_PORT="${{ secrets.MINECRAFT_PORT }}"
          [ -z "$MC_PORT" ] && MC_PORT=25565

          echo "--- Checking health ---"
          for i in {1..12}; do
            if mcstatus "$CONTAINER_IP:$MC_PORT" check; then
              echo "Server is healthy"
              # On success, remove the backup
              lxc exec --project "$LXC_PROJECT" "$LXC_CONTAINER" -- rm -f "${DEPLOYED_JAR_PATH}.bak"
              exit 0
            fi
            echo "Waiting 10s..."
            sleep 10
          done
          echo "!!! Health check failed, triggering rollback !!!"
          exit 1

    - name: Rollback on Failure
      if: failure()
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          set -e
          LXC_CONTAINER="${{ env.CONTAINER }}"
          LXC_PROJECT="${{ secrets.LXD_PROJECT_NAME }}"
          MOD_DIR="${{ secrets.MOD_DEST_PATH }}"
          DEPLOYED_JAR_PATH="${MOD_DIR}/${{ env.JAR_NAME }}"
          BACKUP_JAR_PATH="${DEPLOYED_JAR_PATH}.bak"

          # Remove the failed JAR
          lxc exec --project "$LXC_PROJECT" "$LXC_CONTAINER" -- rm -f "$DEPLOYED_JAR_PATH"
          
          # Restore the backup if it exists
          if lxc exec --project "$LXC_PROJECT" "$LXC_CONTAINER" -- test -f "$BACKUP_JAR_PATH"; then
            echo "--- Restoring backup ---"
            lxc exec --project "$LXC_PROJECT" "$LXC_CONTAINER" -- mv "$BACKUP_JAR_PATH" "$DEPLOYED_JAR_PATH"
          else
            echo "--- No backup found ---"
          fi
